<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hanzi Vocab ¬∑ Lessons 11‚Äì20</title>
  <style>
    :root{ --paper:#FAF4DF; --ink:#181818; --line:#d9cfb4; --card:#fffaf0; --muted:#5e5e5e; }
    *{box-sizing:border-box} html,body{margin:0;background:var(--paper);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,
        "PingFang SC","Hiragino Sans GB","Microsoft YaHei","Source Han Sans SC",sans-serif;}
    body{
      background-image:
        radial-gradient(rgba(0,0,0,0.035) 1px, transparent 1px),
        repeating-linear-gradient(0deg, rgba(0,0,0,0.02), rgba(0,0,0,0.02) 1px, transparent 1px, transparent 12px);
      background-size: 3px 3px, 100% 14px;
    }
    header{position:sticky;top:0;z-index:10;background:rgba(250,244,223,.92);
      border-bottom:1px solid var(--line);backdrop-filter: blur(6px)}
    .wrap{max-width:1000px;margin:0 auto;padding:14px}
    h1{margin:0 0 8px;font-size:20px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:12px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid #d8d0bb;cursor:pointer;background:#fff}
    .pill.active{background:#2f6adf;color:#fff;border-color:#2f6adf}
    select{background:#fff;border:1px solid #d8d0bb;color:var(--ink);padding:8px 10px;border-radius:10px;outline:none}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;gap:10px}
    @media(min-width:900px){ .grid-2{grid-template-columns: 1.2fr .8fr} }
    /* List */
    .list{display:grid;gap:8px}
    .item{display:grid;grid-template-columns: 56px 1fr;gap:10px;align-items:center;
      background:#fff;border:1px solid #e4dcc7;border-radius:12px;padding:8px 10px;cursor:pointer}
    .item:hover{background:#fff7df}
    .idx{color:#7a715d;font-size:12px;text-align:center}
    .hanzi{font-size:26px;line-height:1.2;color:var(--ink);
      font-family:"Kaiti SC","STKaiti","KaiTi","DFKai-SB","BiauKai","Songti SC","Noto Serif CJK SC",serif;}
    .pin{color:#9e5d00;font-size:14px}
    .eng{color:#6c6c6c;font-size:13px}
    .viewer{position:sticky;top:74px}
    .word-title{font-size:28px;margin:0 0 6px;color:var(--ink);
      font-family:"Kaiti SC","STKaiti","KaiTi","DFKai-SB","BiauKai","Songti SC","Noto Serif CJK SC",serif;}
    .boxwrap{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px}
    .charbox{background:#fff;border:1px solid #e6dcc5;border-radius:10px;padding:8px}
    .playbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .tag{display:inline-block;font-size:12px;color:#5b5b5b;border:1px solid #d8d0bb;padding:2px 6px;border-radius:8px;background:#fff}
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#fff;
      border:1px solid #d8d0bb;color:#181818;padding:8px 12px;border-radius:10px;z-index:9999}
    .hidden{display:none}
  </style>
  <script>
    // Offline-first: prefer local vendor, no external CDNs
    window.OFFLINE_STRICT = true;
  </script>
  <!-- Prefer local vendor file. Support either hanzi-writer.min.js or hanzi-writer.js -->
  <script>
    (function(){
      function add(src, onload){
        var s = document.createElement('script'); s.src = src; s.onload = onload; s.onerror = onload; document.head.appendChild(s);
      }
      // Try min first, then non-min
      add('/vendor/hanzi-writer.min.js', function(){
        if(typeof HanziWriter === 'undefined'){ add('/vendor/hanzi-writer.js', function(){}); }
      });
    })();
  </script>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Hanzi Vocab ¬∑ Lessons 11‚Äì20</h1>
    <div class="row" style="gap:12px">
      <div class="card" style="flex:1 1 420px">
        <div class="row" style="align-items:center;gap:8px">
          <label>Lesson</label>
          <select id="lessonSel"></select>
          <div class="pill" id="reloadBtn">Reload</div>
          <div class="muted" style="margin-left:auto">Character set:</div>
          <div id="scriptBar" class="row" style="gap:6px">
            <span class="pill" data-script="simp">Simplified</span>
            <span class="pill" data-script="trad">Traditional</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="wrap grid grid-2">
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="muted"></div>
      <div class="row">
        <input id="search" type="text" placeholder="Search (Hanzi / Pinyin / English)" style="background:#fff;border:1px solid #d8d0bb;color:#181818;padding:8px 10px;border-radius:10px;outline:none" />
      </div>
    </div>
    <div id="list" class="list" style="margin-top:10px"></div>
  </section>

  <aside class="card viewer">
    <div id="viewerEmpty" class="muted">üëà Select a word to view stroke order</div>
    <div id="viewer" class="hidden">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 id="wordTitle" class="word-title">‚Äî‚Äî</h2>
          <div class="pin" id="wordPin"></div>
          <div class="eng" id="wordEng"></div>
          <div class="row" style="gap:8px;margin-top:6px">
            <span class="tag" id="tagScript"></span>
            <span class="tag" id="tagLesson"></span>
          </div>
        </div>
        <div class="playbar">
          <button id="playAll">Play</button>
          <button id="replay">Replay</button>
        </div>
      </div>
      <div id="boxwrap" class="boxwrap" style="margin-top:10px"></div>
      <div id="cdnWarn" class="muted hidden" style="margin-top:8px;color:#9b2c2c">
        ‚ö†Ô∏è Local assets missing: please upload <code>/vendor/hanzi-writer.min.js</code> (or <code>hanzi-writer.js</code>) and <code>/bundles/chars-##.json</code>.
      </div>
    </div>
  </aside>
</main>

<script>
  // Fixed JSON path template: ./lesson##.json
  const PATH_TPL = './lesson##.json';
</script>

<script>
  const getScript = () => localStorage.getItem('scriptPref') || 'simp';
  const setScript = (v) => (localStorage.setItem('scriptPref', v), paintScriptBar(), refreshList());
  function paintScriptBar(){
    document.querySelectorAll('#scriptBar .pill').forEach(p=>{
      p.classList.toggle('active', p.dataset.script===getScript());
    });
  }
  document.addEventListener('click',(e)=>{
    const pill=e.target.closest('#scriptBar .pill'); if(!pill) return;
    setScript(pill.dataset.script);
  });

  // Lessons 11-20
  const lessonSel = document.getElementById('lessonSel');
  for(let n=11;n<=20;n++){ const o=document.createElement('option'); o.value=String(n); o.textContent='Lesson '+n; lessonSel.appendChild(o); }
  lessonSel.value='11'; document.getElementById('reloadBtn').onclick=()=>loadLesson(); lessonSel.onchange=()=>loadLesson();

  // Data
  let curLesson = 11; let entries = []; let bundleCache = {};
  async function loadLesson(){
    curLesson = Number(lessonSel.value);
    // 1) vocab
    const path = PATH_TPL.replace('##', String(curLesson).padStart(2,'0'));
    const res = await fetch(path); if(!res.ok){ toast('‚ö†Ô∏è Missing '+path); return; }
    const js = await res.json(); entries = js.entries || [];

    // 2) merged stroke bundle (local only)
    const bpath = `./bundles/chars-${String(curLesson).padStart(2,'0')}.json`;
    const bres = await fetch(bpath); if(bres.ok){ bundleCache[curLesson] = await bres.json(); } else { bundleCache[curLesson] = {}; }
    refreshList(); toast('Loaded Lesson '+curLesson+' ‚Äî '+entries.length+' items.');
  }

  function refreshList(){
    paintScriptBar();
    const list = document.getElementById('list');
    const q = (document.getElementById('search').value||'').trim().toLowerCase();
    list.innerHTML='';
    const useTrad = getScript()==='trad';
    const filtered = entries.filter(e=>{
      const hz = useTrad ? (e.trad||e.simp||'') : (e.simp||e.trad||'');
      const pin=(e.pinyin||'').toLowerCase(); const eng=(e.english||'').toLowerCase();
      return !q || hz.includes(q) || pin.includes(q) || eng.includes(q);
    });
    filtered.forEach((e,i)=>{
      const hz = useTrad ? (e.trad||e.simp||'') : (e.simp||e.trad||'');
      const row = document.createElement('div'); row.className='item';
      row.innerHTML = `<div class="idx">${String(i+1).padStart(2,'0')}</div>
        <div><div class="hanzi">${hz}</div><div class="pin">${e.pinyin||''}</div><div class="eng">${e.english||''}</div></div>`;
      row.onclick = ()=> showStroke(e);
      list.appendChild(row);
    });
    if(!filtered.length){ list.innerHTML='<div class="muted">No results.</div>'; }
  }
  document.getElementById('search').oninput = refreshList;

  function toast(msg){ const el=document.createElement('div'); el.className='toast'; el.textContent=msg;
    document.body.appendChild(el); setTimeout(()=> el.remove(), 2200); }

  // Stroke viewer (local bundles + local hanzi-writer)
  let writers=[];
  function clearViewer(){ writers.forEach(w=> w && w.hideCharacter && w.hideCharacter()); writers=[];
    document.getElementById('boxwrap').innerHTML=''; }
  function showStroke(entry){
    if(typeof HanziWriter==='undefined'){ document.getElementById('cdnWarn').classList.remove('hidden'); return; }
    const useTrad = getScript()==='trad';
    const word = useTrad ? (entry.trad||entry.simp||'') : (entry.simp||entry.trad||'');
    document.getElementById('viewerEmpty').style.display='none';
    document.getElementById('viewer').classList.remove('hidden');
    document.getElementById('wordTitle').textContent = word;
    document.getElementById('wordPin').textContent = entry.pinyin||'';
    document.getElementById('wordEng').textContent = entry.english||'';
    document.getElementById('tagScript').textContent = useTrad?'Traditional':'Simplified';
    document.getElementById('tagLesson').textContent = 'Lesson '+curLesson;
    clearViewer();

    const map = bundleCache[curLesson] || {};
    const chars = Array.from(word).filter(c=>/[\u3400-\u9fff]/.test(c));
    const wrap = document.getElementById('boxwrap');
    if(!Object.keys(map).length){ document.getElementById('cdnWarn').classList.remove('hidden'); wrap.innerHTML='<div class="muted">Local merged bundle not found: bundles/chars-##.json</div>'; return; }
    document.getElementById('cdnWarn').classList.add('hidden');

    chars.forEach((ch, idx)=>{
      const data = map[ch];
      const d=document.createElement('div'); d.className='charbox';
      d.innerHTML=`<div id="char_${idx}" style="width:100%;height:100px"></div>`; wrap.appendChild(d);
      const w=HanziWriter.create(`char_${idx}`, ch, { width:100, height:100, padding:5, showCharacter:true, charData: data });
      writers.push(w);
    });
    (async()=>{ for(const w of writers){ await w.animateCharacter(); } })();
    document.getElementById('playAll').onclick=async()=>{ for(const w of writers){ await w.animateCharacter(); } };
    document.getElementById('replay').onclick=async()=>{ for(const w of writers){ w.hideCharacter(); await w.animateCharacter(); } };
  }

  // Service Worker (offline cache)
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/sw.js').catch(console.warn);
  }
</script>
</body>
</html>
